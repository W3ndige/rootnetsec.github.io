<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="RootNetSec is a site about journey through the world of network security, pentesting, Linux administration, programming an networking. View to learn more!">
    <meta name="author" content="W3ndige">
    <title>Buffer Overflow - Root Network Security</title>

    <link rel="canonical" href="http://localhost:4000/2016/08/20/buffer-overflow/">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.png">
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//https://fonts.googleapis.com/css?family=Nunito:400,700i" rel="stylesheet">
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->


    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Root Network Security" />

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Root Network Security</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/about/">About</a>
                </li>

                <li>
                    <a href="/archive/">Archive</a>
                </li>

                <li>
                    <a href="/contact/">Contact</a>
                </li>

                <li>
                    <a href="/projects/">Projects</a>
                </li>

                <li>
                    <a href="/resources/">Resources</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/buffer-overflow-header.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Buffer Overflow</h1>
                    
                    <h2 class="subheading">Introduction to Reverse Engineering</h2>
                    
                    <span class="meta">Posted by W3ndige on August 20, 2016</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<h1><a name="introduction">Introductions</a></h1>
<p>Exploiting a buffer overflow vulnerability is very creative and a bit difficult to understand as it takes many different parts of computer technology knowledge to understand and pull off an attack. But after mastering, it's such a powerfull skill, as there are still programs with that kind of vulnerability. In addtion it lets you better understand how computers and programs work.</p>
<p>Let's explore this topic together!</p>
<p><b>Content</b></p>
<ol>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#memory">Memory</a></li>
<li><a href="#registers">Registers</a></li>
<li><a href="#buffer-overflow">Buffer Overflow</a></li>




</ol>

<h1><a name="memory">How the memory is organized?</a></h1>
<p>We're gonna start by briefly examining the memory layout of a C program, especially the stack since this is a place where most of the buffer overflows occurs. </p>
<p><img src="/img/buffer-overflow/address-space.png" alt="address-space" class="img-responsive" /></p>

<p><b>Kernel</b> - Section storing command line parameters that we pass to the program and environment variables. </p>
<p><b>Stack</b> - Stack holds local variables,  function parameters and return addresses for each of your functions. We will come back to it in more detail just in a minute. </p>
<p><b>Heap</b> - Dynamically allocated memory for large chunks of data. The heap grows upwards in memory (from lower to higher memory addresses) as more and more memory is required.</p>
<p><b>Data</b> - Place for initialized and unitialized variables.</p>
<p><b>Text</b> - This is the section where the code of the executable stored. It is often read only cause you don't want to be messing around with that ;)</p>

<h1><a name="registers">What about registers?</a></h1>
<p><b>%ESP</b> - Extended Stack Pointer register which purpose is to let you know where on the stack you are. As the stack grows downward in memory (from higher address values to lower address values) the %ESP register points to the lowest memory address.</p>
<p><b>%EBP</b> - Extended Base Stack Pointer pointing to the base address of stack. Local variables are accessed by subtracting offsets from %EBP and function parameters are accessed by adding offsets to it.</p>
<p><b>%EIP</b> - Extended Instruction Pointer contains the address of the next instruction to read on the program. It points always to the <i>Text</i> segment.</p>

<p>Here you can take a look how the stack with few parameters can look like, together with the registers. </p>
<p><img src="/img/buffer-overflow/stack.png" alt="stack" class="img-responsive" /></p>
<p>Now let's look at this simple code.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">func</span><span class="p">(</span><span class="kt">int</span> <span class="n">param_1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param_2</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">param_3</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">param_4</span><span class="p">;</span>
    <span class="c1">// some code
</span><span class="p">}</span>
<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">func</span><span class="p">(</span><span class="n">param_1</span><span class="p">,</span> <span class="n">param_2</span><span class="p">);</span>
    <span class="c1">// next instruction
</span><span class="p">}</span></code></pre></figure>

<p>Assume that our <i>%EIP</i> is pointing to the <i>func</i> call in <i>main</i>. Now the following steps would be taken: </p>
<ol>
<li>Firstly a function call is found, push parameters on the stack from right to left (<i>param_2</i> first, then <i>param_1</i>)</li>
<li>Now we need to know where to return after <i>func</i> is completed, so push the address of the next instruction on the stack.</li>
<li>Find the address of <i>func</i> and set <i>%EIP</i> to that value. Next we're moving to the <i>func()</i></li>
<li>As we are in the function we need to update <i>%EBP</i>. But before that, we save it onto the stack, so we can later come back to <i>main()</i> </li>
<li>Set <i>%EBP</i> to be equal to <i>%ESP</i>. <i>%EBP</i> now points to current stack pointer.</li>
<li>Push local variables onto the stack. <i>%ESP</i> is being changed in this step.</li>
<li>After func gets over we need to reset the previous stack frame. So set <i>%ESP</i> back to <i>%EBP</i>. Then pop the earlier <i>%EBP</i> from stack, store it back in <i>%EBP</i>. That way pointer register points back to where it pointed in <i>main()</i>.</li>
<li>Pop the return address from stack and set <i>%EIP</i> to it. The control flow comes back to <i>main</i>, just after the func function call.</li>

</ol>

<h1><a name="buffer-overflow">Buffer Overflow Vulnerability</a></h1>
<p>Now as we know the concept behind the memory of running program, let's take a look at vulnerability called buffer overflow. </p>
<p>A <b>buffer overflow</b> happens when you assign more data than can fit into the buffer and overwriting the code beyond memory address resulting in program crash.However the problem is that somewhere beyond your buffer is the return address and if you manage to load byte code of your program you may be able to execute it. It may result with privilage escalation, where you byte code is intended to open the shell, as well as an ability to run functions that were not intended to run at that moment.  </p>
<p>Now let's look at this simple example: </p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="cp">#include &lt;string.h&gt;
</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">pass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Enter the password : </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">gets</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">"strongpassword"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">printf</span> <span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Wrong Password </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">printf</span> <span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Correct Password </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">pass</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">pass</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span> <span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> I love cookies! </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>We've got this simple C program that asks for a password from user and if the password is correct then it provides you with a a secret.</p>

<p>To compile it we can use this built in gcc compiler. </p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">gcc vuln.c -o pass -fno-stack-protector</code></pre></figure>

<p>With -fno-stack-protector argument that will disable the stack protection. </p>
<p>Version to compile 32 bit binaries: </p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">gcc vuln.c -o pass -fno-stack-protector -m32</code></pre></figure>

<p>You may need to install 32 bit utilities in order to compile 32 bit binaries. This command worked for me:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">apt-get install gcc-multilib</code></pre></figure>

<p>Now you can run it by typing this command. As you see it asks us for a password and then if the password is correct it provides us with a secret. </p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>./pass

 Enter the password :
strongpassword

 Correct Password

 I love cookies</code></pre></figure>

<p>But what if we enter a string that is more than 15 characters long? Let's see. </p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>./pass

 Enter the password :
1111111111111111111111111111111

 Wrong Password

 I love cookies
Segmentation Fault</code></pre></figure>

<p>Even though we entered wrong password it gave us a secret. This is because  attacker supplied an input of length greater than what buffer can hold and it overwrote the memory of integer ‘pass’. So despite of a wrong password, the value of ‘pass’ became non zero and since then the secret was given. </p>

<p>If you're a C programmer and want to avoid buffer overflows there are few tips that can help your work: </p>
<p>[*] Use <b>fgets()</b> instead of gets()</p>
<p>[*] Use <b>strncmp()</b> instead of strcmp(), <b>strncpy()</b> instead of strcpy() and so on.</p>
<p>[*] Make sure that the <b>memory auditing</b> is done properly</p>

<p>That's the logic behind basic buffer overflows, as you may know there are more advanced cases like injecting machine code that can provide us with root shell and so on. We will explore this together in the next part of reverse engineering series. </p>
<p>As always I hope you enjoyed exploring this topic with me and keep tuned for the next part about shellcodes!</p>
<p>~Stay safe!</p>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2016/08/18/hash-functions/" data-toggle="tooltip" data-placement="top" title="Hash Functions">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2016/08/25/cross-site-scripting-introduction/" data-toggle="tooltip" data-placement="top" title="Cross Site Scripting">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/w3ndige">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="mailto:w3ndige@protonmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; RootNetSec 2016 - 2017</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
